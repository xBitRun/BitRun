name: Deploy to Production

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE/**'
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild all images'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: read

concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  INSTALL_DIR: /opt/bitrun

jobs:
  # Run tests before deployment
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: backend/requirements.txt

      - name: Install backend dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run backend tests
        working-directory: backend
        run: pytest -m "not integration" -q || true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci --legacy-peer-deps

      - name: Run frontend tests
        working-directory: frontend
        run: npm test -- --passWithNoTests || true

      - name: Build frontend
        working-directory: frontend
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: https://${{ secrets.BACKEND_DOMAIN }}/api/v1
          NEXT_PUBLIC_WS_URL: wss://${{ secrets.BACKEND_DOMAIN }}/api/v1/ws
          NEXT_PUBLIC_BRAND_NAME: ${{ secrets.NEXT_PUBLIC_BRAND_NAME || 'BITRUN' }}
          NEXT_PUBLIC_BRAND_SHORT_NAME: ${{ secrets.NEXT_PUBLIC_BRAND_SHORT_NAME || 'BITRUN' }}
          NEXT_PUBLIC_BRAND_TAGLINE: ${{ secrets.NEXT_PUBLIC_BRAND_TAGLINE || 'AI-Powered Trading Agent' }}
          NEXT_PUBLIC_BRAND_THEME_PRESET: ${{ secrets.NEXT_PUBLIC_BRAND_THEME_PRESET || 'bitrun' }}

  # Deploy to production server
  deploy:
    name: Deploy to Production
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          envs: |
            FRONTEND_DOMAIN,
            BACKEND_DOMAIN,
            POSTGRES_PASSWORD,
            JWT_SECRET,
            DATA_ENCRYPTION_KEY,
            REDIS_PASSWORD,
            ADMIN_EMAIL,
            ADMIN_PASSWORD,
            ADMIN_NAME,
            TELEGRAM_BOT_TOKEN,
            TELEGRAM_CHAT_ID,
            DISCORD_WEBHOOK_URL,
            RESEND_API_KEY,
            RESEND_FROM,
            PROXY_URL,
            SENTRY_DSN,
            BRAND_NAME,
            BRAND_TAGLINE,
            NEXT_PUBLIC_BRAND_NAME,
            NEXT_PUBLIC_BRAND_SHORT_NAME,
            NEXT_PUBLIC_BRAND_TAGLINE,
            NEXT_PUBLIC_BRAND_DESCRIPTION,
            NEXT_PUBLIC_BRAND_LOGO_DEFAULT,
            NEXT_PUBLIC_BRAND_LOGO_COMPACT,
            NEXT_PUBLIC_BRAND_LOGO_ICON,
            NEXT_PUBLIC_BRAND_FAVICON,
            NEXT_PUBLIC_BRAND_THEME_PRESET,
            NEXT_PUBLIC_BRAND_THEME_COLORS_OVERRIDE,
            NEXT_PUBLIC_BRAND_COPYRIGHT_HOLDER,
            NEXT_PUBLIC_BRAND_TERMS_URL,
            NEXT_PUBLIC_BRAND_PRIVACY_URL,
            NEXT_PUBLIC_BRAND_HOMEPAGE_URL,
            NEXT_PUBLIC_BRAND_DOCS_URL,
            NEXT_PUBLIC_BRAND_SUPPORT_URL
          script: |
            set -e

            echo "ðŸš€ Starting deployment..."

            # Create installation directory
            mkdir -p ${{ env.INSTALL_DIR }}
            cd ${{ env.INSTALL_DIR }}

            # Pull latest code
            echo "ðŸ“¥ Pulling latest code..."
            if [ -d ".git" ]; then
              git fetch origin main
              git reset --hard origin/main
            else
              git clone https://github.com/xBitRun/BitRun.git .
            fi

            # Update docker-compose (nginx config is in git repo)
            echo "ðŸ“¥ Updating configuration files..."
            curl -fsSL https://raw.githubusercontent.com/xBitRun/BitRun/main/docker-compose.prod.yml -o docker-compose.yml

            # Generate .env from GitHub Secrets
            echo "ðŸ” Generating environment configuration..."
            cat > .env << ENVEOF
            # BITRUN Production Configuration
            # Auto-generated from GitHub Secrets
            # Generated at: $(date -u +"%Y-%m-%dT%H:%M:%SZ")

            # ==================== Domains ====================
            FRONTEND_DOMAIN=${{ secrets.FRONTEND_DOMAIN }}
            BACKEND_DOMAIN=${{ secrets.BACKEND_DOMAIN }}

            # ==================== Required Secrets ====================
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            DATA_ENCRYPTION_KEY=${{ secrets.DATA_ENCRYPTION_KEY }}
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}

            # ==================== Database ====================
            POSTGRES_DB=bitrun
            POSTGRES_USER=bitrun

            # ==================== Ports ====================
            HTTP_PORT=80
            HTTPS_PORT=443

            # ==================== URLs ====================
            CORS_ORIGINS=https://${{ secrets.FRONTEND_DOMAIN }}
            NEXT_PUBLIC_API_URL=https://${{ secrets.BACKEND_DOMAIN }}/api/v1
            NEXT_PUBLIC_WS_URL=wss://${{ secrets.BACKEND_DOMAIN }}/api/v1/ws

            # ==================== Worker ====================
            WORKER_ENABLED=true

            # ==================== Admin Account ====================
            ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}
            ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
            ADMIN_NAME=${{ secrets.ADMIN_NAME }}

            # ==================== Frontend Brand Configuration ====================
            NEXT_PUBLIC_BRAND_NAME=${{ secrets.NEXT_PUBLIC_BRAND_NAME || 'BITRUN' }}
            NEXT_PUBLIC_BRAND_SHORT_NAME=${{ secrets.NEXT_PUBLIC_BRAND_SHORT_NAME || 'BITRUN' }}
            NEXT_PUBLIC_BRAND_TAGLINE=${{ secrets.NEXT_PUBLIC_BRAND_TAGLINE || 'AI-Powered Trading Agent' }}
            NEXT_PUBLIC_BRAND_DESCRIPTION=${{ secrets.NEXT_PUBLIC_BRAND_DESCRIPTION || 'Prompt-driven automated trading with AI decision making' }}
            NEXT_PUBLIC_BRAND_LOGO_DEFAULT=${{ secrets.NEXT_PUBLIC_BRAND_LOGO_DEFAULT }}
            NEXT_PUBLIC_BRAND_LOGO_COMPACT=${{ secrets.NEXT_PUBLIC_BRAND_LOGO_COMPACT }}
            NEXT_PUBLIC_BRAND_LOGO_ICON=${{ secrets.NEXT_PUBLIC_BRAND_LOGO_ICON }}
            NEXT_PUBLIC_BRAND_FAVICON=${{ secrets.NEXT_PUBLIC_BRAND_FAVICON || '/logo.png' }}
            NEXT_PUBLIC_BRAND_THEME_PRESET=${{ secrets.NEXT_PUBLIC_BRAND_THEME_PRESET || 'bitrun' }}
            NEXT_PUBLIC_BRAND_THEME_COLORS_OVERRIDE=${{ secrets.NEXT_PUBLIC_BRAND_THEME_COLORS_OVERRIDE }}
            NEXT_PUBLIC_BRAND_COPYRIGHT_HOLDER=${{ secrets.NEXT_PUBLIC_BRAND_COPYRIGHT_HOLDER || 'BITRUN' }}
            NEXT_PUBLIC_BRAND_TERMS_URL=${{ secrets.NEXT_PUBLIC_BRAND_TERMS_URL || '/terms' }}
            NEXT_PUBLIC_BRAND_PRIVACY_URL=${{ secrets.NEXT_PUBLIC_BRAND_PRIVACY_URL || '/privacy' }}
            NEXT_PUBLIC_BRAND_HOMEPAGE_URL=${{ secrets.NEXT_PUBLIC_BRAND_HOMEPAGE_URL || format('https://{0}', secrets.FRONTEND_DOMAIN) }}
            NEXT_PUBLIC_BRAND_DOCS_URL=${{ secrets.NEXT_PUBLIC_BRAND_DOCS_URL }}
            NEXT_PUBLIC_BRAND_SUPPORT_URL=${{ secrets.NEXT_PUBLIC_BRAND_SUPPORT_URL }}

            # ==================== Notifications (Optional) ====================
            TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
            TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}
            DISCORD_WEBHOOK_URL=${{ secrets.DISCORD_WEBHOOK_URL }}
            RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}
            RESEND_FROM=${{ secrets.RESEND_FROM }}

            # ==================== Optional Features ====================
            PROXY_URL=${{ secrets.PROXY_URL }}
            SENTRY_DSN=${{ secrets.SENTRY_DSN }}

            # ==================== Backend Brand (for notifications) ====================
            BRAND_NAME=${{ secrets.BRAND_NAME || 'BITRUN' }}
            BRAND_TAGLINE=${{ secrets.BRAND_TAGLINE || 'AI-Powered Trading Agent' }}

            # ==================== System ====================
            TZ=Asia/Shanghai
            ENVEOF

            chmod 600 .env

            # Rebuild and restart
            echo "ðŸ”¨ Rebuilding services..."
            if [ "${{ inputs.force_rebuild }}" = "true" ]; then
              docker compose build --no-cache
            else
              docker compose build
            fi

            echo "ðŸ”„ Restarting services..."
            docker compose up -d

            # Wait for services
            echo "â³ Waiting for services..."
            sleep 15

            # Run migrations
            echo "ðŸ“¦ Running migrations..."
            docker compose exec -T backend alembic upgrade head || true

            # Cleanup old images
            echo "ðŸ§¹ Cleaning up..."
            docker image prune -af --filter "until=24h"

            echo "âœ… Deployment complete!"
            echo ""
            echo "Frontend: https://${{ secrets.FRONTEND_DOMAIN }}"
            echo "Backend:  https://${{ secrets.BACKEND_DOMAIN }}"

      - name: Health check
        run: |
          echo "ðŸ¥ Checking frontend health..."
          curl -sf https://${{ secrets.FRONTEND_DOMAIN }} || echo "Frontend health check failed"

          echo "ðŸ¥ Checking backend health..."
          curl -sf https://${{ secrets.BACKEND_DOMAIN }}/api/v1/health || echo "Backend health check failed"

  # Notify on failure
  notify-failure:
    name: Notify on Failure
    needs: [test, deploy]
    if: failure()
    runs-on: ubuntu-latest

    steps:
      - name: Send notification
        if: ${{ secrets.TELEGRAM_BOT_TOKEN != '' && secrets.TELEGRAM_CHAT_ID != '' }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="ðŸš¨ BitRun Deployment Failed!\n\nCommit: ${{ github.sha }}\nAuthor: ${{ github.actor }}\nWorkflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
